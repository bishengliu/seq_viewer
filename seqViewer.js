var sequence = "GAGCTTGGCCCATTGCATACGTTGTATCCATATCATAATATGTACATTTATATTGGCTCATGTCCAACATTACCGCCATGTTGACATTGATTATTGACTAGTTATTAATAGTAATCAATTACGGGGTCATTAGTTCATAGCCCATATATGGAGTTCCGCGTTACATAACTTACGGTAAATGGCCCGCCTGGCTGACCGCCCAACGACCCCCGCCCATTGACGTCAATAATGACGTATGTTCCCATAGTAACGCCAATAGGGACTTTCCATTGACGTCAATGGGTGGAGTATTTACGGTAAACTGCCCACTTGGCAGTACATCAAGTGTATCATATGCCAAGTACGCCCCCTATTGACGTCAATGACGGTAAATGGCCCGCCTGGCATTATGCCCAGTACATGACCTTATGGGACTTTCCTACTTGGCAGTACATCTACGTATTAGTCATCGCTATTACCATGGTGATGCGGTTTTGGCAGTACATCAATGGGCGTGGATAGCGGTTTGACTCACGGGGATTTCCAAGTCTCCACCCCATTGACGTCAATGGGAGTTTGTTTTGGCACCAAAATCAACGGGACTTTCCAAAATGTCGTAACAACTCCGCCCCATTGACGCAAATGGGCGGTAGGCGTGTACGGTGGGAGGTCTATATAAGCAGAGCTCGTTTAGTGAACCGTCAGATCGCCTGGAGACGCCATCCACGCTGTTTTGACCTCCATAGAAGACACCGGGACCGATCCAGCCTCCGGTCGACCGATCCTGAGAACTTCAGGGTGAGTTTGGGGACCCTTGATTGTTCTTTCTTTTTCGCTATTGTAAAATTCATGTTATATGGAGGGGGCAAAGTTTTCAGGGTGTTGTTTAGAATGGGAAGATGTCCCTTGTATCACCATGGACCCTCATGATAATTTTGTTTCTTTCACTTTCTACTCTGTTGACAACCATTGTCTCCTCTTATTTTCTTTTCATTTTCTGTAACTTTTTCGTTAAACTTTAGCTTGCATTTGTAACGAATTTTTAAATTCACTTTTGTTTATTTGTCAGATTGTAAGTACTTTCTCTAATCACTTTTTTTTCAAGGCAATCAGGGTATATTATATTGTACTTCAGCACAGTTTTAGAGAACAATTGTTATAATTAAATGATAAGGTAGAATATTTCTGCATATAAATTCTGGCTGGCGTGGAAATATTCTTATTGGTAGAAACAACTACACCCTGGTCATCATCCTGCCTTTCTCTTTATGGTTACAATGATATACACTGTTTGAGATGAGGATAAAATACTCTGAGTCCAAACCGGGCCCCTCTGCTAACCATGTTCATGCCTTCTTCTCTTTCCTACAGCTCCTGGGCAACGTGCTGGTTGTTGTGCTGTCTCATCATTTTGGCAAAGAATTCCTCGACGGATCCCTCGAGGAATTCTGACACTATGAAGTGCCTTTTGTACTTAGCCTTTTTATTCATTGGGGTGAATTGCAAGTTCACCATAGTTTTTCCACACAACCAAAAAGGAAACTGGAAAAATGTTCCTTCTAATTACCATTATTGCCCGTCAAGCTCAGATTTAAATTGGCATAATGACTTAATAGGCACAGCCTTACAAGTCAAAATGCCCAAGAGTCACAAGGCTATTCAAGCAGACGGTTGGATGTGTCATGCTTCCAAATGGGTCACTACTTGTGATTTCCGCTGGTATGGACCGAAGTATATAACACATTCCATCCGATCCTTCACTCCATCTGTAGAACAATGCAAGGAAAGCATTGAACAAACGAAACAAGGAACTTGGCTGAATCCAGGCTTCCCTCCTCAAAGTTGTGGATATGCAACTGTGACGGATGCCGAAGCAGTGATTGTCCAGGTGACTCCTCACCATGTGCTGGTTGATGAATACACAGGAGAATGGGTTGATTCACAGTTCATCAACGGAAAATGCAGCAATTACATATGCCCCACTGTCCATAACTCTACAACCTGGCATTCTGACTATAAGGTCAAAGGGCTATGTGATTCTAACCTCATTTCCATGGACATCACCTTCTTCTCAGAGGACGGAGAGCTATCATCCCTGGGAAAGGAGGGCACAGGGTTCAGAAGTAACTACTTTGCTTATGAAACTGGAGGCAAGGCCTGCAAAATGCAATACTGCAAGCATTGGGGAGTCAGACTCCCATCAGGTGTCTGGTTCGAGATGGCTGATAAGGATCTCTTTGCTGCAGCCAGATTCCCTGAATGCCCAGAAGGGTCAAGTATCTCTGCTCCATCTCAGACCTCAGTGGATGTAAGTCTAATTCAGGACGTTGAGAGGATCTTGGATTATTCCCTCTGCCAAGAAACCTGGAGCAAAATCAGAGCGGGTCTTCCAATCTCTCCAGTGGATCTCAGCTATCTTGCTCCTAAAAACCCAGGAACCGGTCCTGCTTTCACCATAATCAATGGTACCCTAAAATACTTTGAGACCAGATACATCAGAGTCGATATTGCTGCTCCAATCCTCTCAAGAATGGTCGGAATGATCAGTGGAACTACCACAGAAAGGGAACTGTGGGATGACTGGGCACCATATGAAGACGTGGAAATTGGACCCAATGGAGTTCTGAGGACCAGTTCAGGATATAAGTTTCCTTTATACATGATTGGACATGGTATGTTGGACTCCGATCTTCATCTTAGCTCAAAGGCTCAGGTGTTCGAACATCCTCACATTCAAGACGCTGCTTCGCAACTTCCTGATGATGAGAGTTTATTTTTTGGTGATACTGGGCTATCCAAAAATCCAATCGAGCTTGTAGAAGGTTGGTTCAGTAGTTGGAAAAGCTCTATTGCCTCTTTTTTCTTTATCATAGGGTTAATCATTGGACTATTCTTGGTTCTCCGAGTTGGTATCCATCTTTGCATTAAATTAAAGCACACCAAGAAAAGACAGATTTATACAGACATAGAGATGAACCGACTTGGAAAGTAACTCAAATCCTGCACAACAGATTCTTCATGTTTGGACCAAATCAACTTGTGATACCATGCTCAAAGAGGCCTCAATTATATTTGAGTTTTTAATTTTTATGAAAAAAAAAAAAAAAAACGGAATTCCTCGAGGGATCCGTCGAGGAATTCACTCCTCAGGTGCAGGCTGCCTATCAGAAGGTGGTGGCTGGTGTGGCCAATGCCCTGGCTCACAAATACCACTGAGATCTTTTTCCCTCTGCCAAAAATTATGGGGACATCATGAAGCCCCTTGAGCATCTGACTTCTGGCTAATAAAGGAAATTTATTTTCATTGCAATAGTGTGTTGGAATTTTTTGTGTCTCTCACTCGGAAGGACATATGGGAGGGCAAATCATTTAAAACATCAGAATGAGTATTTGGTTTAGAGTTTGGCAACATATGCCCATATGCTGGCTGCCATGAACAAAGGTTGGCTATAAAGAGGTCATCAGTATATGAAACAGCCCCCTGCTGTCCATTCCTTATTCCATAGAAAAGCCTTGACTTGAGGTTAGATTTTTTTTATATTTTGTTTTGTGTTATTTTTTTCTTTAACATCCCTAAAATTTTCCTTACATGTTTTACTAGCCAGATTTTTCCTCCTCTCCTGACTACTCCCAGTCATAGCTGTCCCTCTTCTCTTATGGAGATCCCTCGACGGATCGGCCGCAATTCGTAATCATGTCATAGCTGTTTCCTGTGTGAAATTGTTATCCGCTCACAATTCCACACAACATACGAGCCGGAAGCATAAAGTGTAAAGCCTGGGGTGCCTAATGAGTGAGCTAACTCACATTAATTGCGTTGCGCTCACTGCCCGCTTTCCAGTCGGGAAACCTGTCGTGCCAGCTGCATTAATGAATCGGCCAACGCGCGGGGAGAGGCGGTTTGCGTATTGGGCGCTCTTCCGCTTCCTCGCTCACTGACTCGCTGCGCTCGGTCGTTCGGCTGCGGCGAGCGGTATCAGCTCACTCAAAGGCGGTAATACGGTTATCCACAGAATCAGGGGATAACGCAGGAAAGAACATGTGAGCAAAAGGCCAGCAAAAGGCCAGGAACCGTAAAAAGGCCGCGTTGCTGGCGTTTTTCCATAGGCTCCGCCCCCCTGACGAGCATCACAAAAATCGACGCTCAAGTCAGAGGTGGCGAAACCCGACAGGACTATAAAGATACCAGGCGTTTCCCCCTGGAAGCTCCCTCGTGCGCTCTCCTGTTCCGACCCTGCCGCTTACCGGATACCTGTCCGCCTTTCTCCCTTCGGGAAGCGTGGCGCTTTCTCATAGCTCACGCTGTAGGTATCTCAGTTCGGTGTAGGTCGTTCGCTCCAAGCTGGGCTGTGTGCACGAACCCCCCGTTCAGCCCGACCGCTGCGCCTTATCCGGTAACTATCGTCTTGAGTCCAACCCGGTAAGACACGACTTATCGCCACTGGCAGCAGCCACTGGTAACAGGATTAGCAGAGCGAGGTATGTAGGCGGTGCTACAGAGTTCTTGAAGTGGTGGCCTAACTACGGCTACACTAGAAGAACAGTATTTGGTATCTGCGCTCTGCTGAAGCCAGTTACCTTCGGAAAAAGAGTTGGTAGCTCTTGATCCGGCAAACAAACCACCGCTGGTAGCGGTGGTTTTTTTGTTTGCAAGCAGCAGATTACGCGCAGAAAAAAAGGATCTCAAGAAGATCCTTTGATCTTTTCTACGGGGTCTGACGCTCAGTGGAACGAAAACTCACGTTAAGGGATTTTGGTCATGAGATTATCAAAAAGGATCTTCACCTAGATCCTTTTAAATTAAAAATGAAGTTTTAAATCAATCTAAAGTATATATGAGTAAACTTGGTCTGACAGTTACCAATGCTTAATCAGTGAGGCACCTATCTCAGCGATCTGTCTATTTCGTTCATCCATAGTTGCCTGACTCCCCGTCGTGTAGATAACTACGATACGGGAGGGCTTACCATCTGGCCCCAGTGCTGCAATGATACCGCGAGACCCACGCTCACCGGCTCCAGATTTATCAGCAATAAACCAGCCAGCCGGAAGGGCCGAGCGCAGAAGTGGTCCTGCAACTTTATCCGCCTCCATCCAGTCTATTAATTGTTGCCGGGAAGCTAGAGTAAGTAGTTCGCCAGTTAATAGTTTGCGCAACGTTGTTGCCATTGCTACAGGCATCGTGGTGTCACGCTCGTCGTTTGGTATGGCTTCATTCAGCTCCGGTTCCCAACGATCAAGGCGAGTTACATGATCCCCCATGTTGTGCAAAAAAGCGGTTAGCTCCTTCGGTCCTCCGATCGTTGTCAGAAGTAAGTTGGCCGCAGTGTTATCACTCATGGTTATGGCAGCACTGCATAATTCTCTTACTGTCATGCCATCCGTAAGATGCTTTTCTGTGACTGGTGAGTACTCAACCAAGTCATTCTGAGAATAGTGTATGCGGCGACCGAGTTGCTCTTGCCCGGCGTCAATACGGGATAATACCGCGCCACATAGCAGAACTTTAAAAGTGCTCATCATTGGAAAACGTTCTTCGGGGCGAAAACTCTCAAGGATCTTACCGCTGTTGAGATCCAGTTCGATGTAACCCACTCGTGCACCCAACTGATCTTCAGCATCTTTTACTTTCACCAGCGTTTCTGGGTGAGCAAAAACAGGAAGGCAAAATGCCGCAAAAAAGGGAATAAGGGCGACACGGAAATGTTGAATACTCATACTCTTCCTTTTTCAATATTATTGAAGCATTTATCAGGGTTATTGTCTCATGAGCGGATACATATTTGAATGTATTTAGAAAAATAAACAAATAGGGGTTCCGCGCACATTTCCCCGAAAAGTGCCACCTAAATTGTAAGCGTTAATATTTTGTTAAAATTCGCGTTAAATTTTTGTTAAATCAGCTCATTTTTTAACCAATAGGCCGAAATCGGCAAAATCCCTTATAAATCAAAAGAATAGACCGAGATAGGGTTGAGTGTTGTTCCAGTTTGGAACAAGAGTCCACTATTAAAGAACGTGGACTCCAACGTCAAAGGGCGAAAAACCGTCTATCAGGGCGATGGCCCACTACGTGAACCATCACCCTAATCAAGTTTTTTGGGGTCGAGGTGCCGTAAAGCACTAAATCGGAACCCTAAAGGGAGCCCCCGATTTAGAGCTTGACGGGGAAAGCCGGCGAACGTGGCGAGAAAGGAAGGGAAGAAAGCGAAAGGAGCGGGCGCTAGGGCGCTGGCAAGTGTAGCGGTCACGCTGCGCGTAACCACCACACCCGCCGCGCTTAATGCGCCGCTACAGGGCGCGTCCCATTCGCCATTCAGGCTGCGCAACTGTTGGGAAGGGCGATCGGTGCGGGCCTCTTCGCTATTACGCCAGCTGGCGAAAGGGGGATGTGCTGCAAGGCGATTAAGTTGGGTAACGCCAGGGTTTTCCCAGTCACGACGTTGTAAAACGACGGCCAGTGAGCGCGCGTAATACGACTCACTATAGGGCGAATTGGAGCTCCACCGCGGTGGCGGCCGCTCTAGA";
var plasmidName = "pCMV-VSV-G Map";

var features = [
    {name: "GAG_enhancer", start: 164, end: 451, color: colores_google(0), clockwise: 0, cut:null},
    {name: "AmpR", start: 4837, end: 5697, color: colores_google(1), clockwise: 0, cut:null},
    {name: "lac_promoter", start: 3725, end: 3754, color: colores_google(2), clockwise: 0, cut:null},
    {name: "rb_glob_PA_terminator", start: 3201, end: 3644, color: colores_google(3), clockwise: 0, cut:null},
    {name: "vsv-G", start: 1436, end: 2124, color: colores_google(4), clockwise: 1, cut:null},
    {name: "CMV_immearly_promoter", start: 84, end: 660, color: colores_google(5), clockwise: 1, cut:null},
    {name: "CMV_promoter", start: 618, end: 687, color: colores_google(6), clockwise: 1, cut:null},
    {name: "CMV2_promoter", start: 630, end: 749, color: colores_google(7), clockwise: 1, cut:null},
    {name: "pBR322_origin", start: 4063, end: 4682, color: colores_google(8), clockwise: 0, cut:null},
    {name: "T7_promoter", start: 6451, end: 6469, color: colores_google(9), clockwise: 0, cut:null},
    {name: "LacZ_a", start: 6284, end: 6432, color: colores_google(10), clockwise: 0, cut:null},
    {name: "5'-LTR", start: 148, end: 974, color: colores_google(11), clockwise: 1, cut:null}
];
//name, start, end, color, clockwise, cut;

//ntPerLine: the number of nt perline
var ntPerLine = 230;

//generate complementary sequence
var cSequence = genCSeq(sequence);

//show complementary sequence
var showComplementary = true;
var symbol = ' ';
//generate sequence array based on the ntPerLine
var seqArray = formatSeq(sequence, symbol, ntPerLine); //array for forward sequence
var cSeqArray = formatSeq(cSequence, symbol, ntPerLine);; //array for complementary sequence


//use d3 to display seq in text and as well as the features
//div id is displaySeq
//draw canvas
//seqWidth and featureWdith will be calculated later
//define the seqWidth
var seqTop =5;
var seqBottom = 10;

var seqWidth = 20;
//enzyme width
var enzymeWidth = 10;
//featureWdith 
var featureWdith = 20;
var arrayLength = seqArray.length;
//draw svg
var svg = drawSVG("#displaySeq", arrayLength, seqTop, enzymeWidth, seqWidth, featureWdith, seqBottom);

//draw forward seq and complementary sequence
var svgSeq= drawSeq(svg, seqArray, symbol, showComplementary, cSeqArray, seqTop, enzymeWidth, seqWidth, featureWdith, seqBottom, ntPerLine, features);


//functions
//render google color
function colores_google(n) {
    var colores_g = ["#3366cc", "#dc3912", "#ff9900", "#109618", "#990099", "#0099c6", "#dd4477", "#66aa00", "#b82e2e", "#316395", "#994499", "#22aa99", "#aaaa11", "#6633cc", "#e67300", "#8b0707", "#651067", "#329262", "#5574a6", "#3b3eac"];
    return colores_g[n % colores_g.length];
}

//generate complementary sequence
function genCSeq(sequence){
    var cSequence ="";
    var cSeqArray = [];
    var seqArray = sequence.toUpperCase().split('');
    $.each(seqArray, function(i, d){
        if(d === "A"){
            cSeqArray.push("T")
        }
        else if(d==="T"){
            cSeqArray.push("A")
        }
        else if(d==="G"){
            cSeqArray.push("C")
        }
        else{
            cSeqArray.push("G")
        }
    })
    return cSeqArray.join('');
}

//generate sequence that split with a symbol every 10 nt and output the array
function formatSeq(sequence, symbol, ntPerLine){
    var outputArray = [];
    var array = sequence.match(new RegExp('.{1,' + ntPerLine + '}', 'g')).join('|').split('|');
    $.each(array, function (i, d) { 
        var itemSeq = d.match(/.{1,10}/g).join(symbol);
        outputArray.push(itemSeq);
     })
     return outputArray;
}

//draw empty using d3
function drawSVG(id, arrayLength, seqTop, enzymeWidth, seqWidth, featureWdith, seqBottom) { 
    var margin = {top: 20, right: 20, bottom: 20, left: 20};
    width = +$(id).width() - margin.left - margin.right;
    height = arrayLength * ( seqTop + enzymeWidth  + seqWidth + featureWdith + seqBottom + features.length*3) - margin.top - margin.bottom;
    //calculate the width
    var svg = d3.select(id)
                .append("svg")
                .attr("width", width + margin.left + margin.right)
			    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                        .attr("transform", "translate(" + margin.left +"," + margin.top + ")");
    return svg;
 }



 //draw sequence
 function drawSeq(svg, seqArray, symbol, showComplementary, cSeqArray, seqTop, enzymeWidth, seqWidth, featureWdith, seqBottom, ntPerLine, features) { 
     var yPos = 5;
    var xShift = 25 // for adding count and vertical line
    var count = 1;
    var yShift = 10;
    //define 10nt width 70.16, sp = 8.50
    // var nt10 = 78.015625;
    // var sp = 23.40625 - (78.015625/10)*2;

    var nt10 = 70.16;
    var sp = 8.50;

    //the with of the middle line between seq
    var middleWidth = 6;
    svgSeq = svg.append("g").attr("id", "seqSVG");
    for(i=0; i< seqArray.length; i++){
        //forward sequence
        var fcSeq = svgSeq.append("g");
                    fcSeq.append("text")
                        .attr("y", yPos)
                        .attr("x", xShift)
                        .style("text-anchor", "begin")
                        .style("font-family", "monospace")
                        .style("font-size", "13px")
                        .style("fill", "#636363")
                        .text(seqArray[i]);
    //add nt count
                    fcSeq.append("text")
                        .attr("y", yPos)
                        .attr("x", 0)
                        .attr("class", "noEvent")
                        .style("text-anchor", "middle")
                        .style("font-family", "monospace")
                        .style("font-size", "13px")
                        .style("fill", "#636363")
                        .text(count + "");
    //show middle nt count
    //first draw horizontal line
    //remove the symbol in the seqArrayItem
    var seqArrayItem = seqArray[i].split(symbol).join('');
    if(seqArrayItem.length == ntPerLine){
            for(c=0; c < Math.trunc(seqArrayItem.length / 10); c++){
                var hline= fcSeq.append("g").append("line")
                                .style("stroke", "#c7c7c7")
                                .style("stroke-width", 0.5)
                                .attr("x1", xShift + nt10/17 + c * (nt10 + sp))
                                .attr("y1", yPos + middleWidth) 
                                .attr("x2", xShift + nt10 - nt10/20 + c * (nt10 + sp)) 
                                .attr("y2", yPos + middleWidth);
            //draw small vertical lines
            for(v=0; v < 10; v++){
                var vline = fcSeq.append("g").append("line")
                                .style("stroke-width", 0.5)
                                .style("stroke", "#c7c7c7")
                                .attr("x1", xShift + c * (nt10 + sp) + nt10/17 + v * nt10/10)
                                .attr("y1", function () { return (v == 0 || v == 9 || v == 5) ? (yPos + 3) : (yPos + 4); }) 
                                .attr("x2", xShift + c * (nt10 + sp)+ nt10/17 + v * nt10/10)
                                .attr("y2", function () { return (v == 0 || v == 9 || v == 5) ? (yPos + 9) : (yPos + 8); });
                        }
            }
    }
    else{
        for(c=0; c < Math.trunc(seqArrayItem.length / 10); c++){
                var hline= fcSeq.append("g").append("line")
                                .style("stroke", "#c7c7c7")
                                .style("stroke-width", 0.5)
                                .attr("x1", xShift + nt10/17 + c * (nt10 + sp))
                                .attr("y1", yPos + middleWidth) 
                                .attr("x2", xShift + nt10 - nt10/20 + c * (nt10 + sp)) 
                                .attr("y2", yPos + middleWidth);
                //draw small vertical lines
                for(v=0; v < 10; v++){
                    var vline = fcSeq.append("g").append("line")
                                    .style("stroke-width", 0.5)
                                    .style("stroke", "#c7c7c7")
                                    .attr("x1", xShift + c * (nt10 + sp) + nt10/17 + v * nt10/10)
                                    .attr("y1", function () { return (v == 0 || v == 9 || v == 5) ? (yPos + 3) : (yPos + 4); }) 
                                    .attr("x2", xShift + c * (nt10 + sp)+ nt10/17 + v * nt10/10)
                                    .attr("y2", function () { return (v == 0 || v == 9 || v == 5) ? (yPos + 9) : (yPos + 8); });
                }
            }
        if(seqArrayItem.length % 10 !=0 ){
            var ntLeft = seqArrayItem.length % 10;
            var hline= fcSeq.append("g").append("line")
                                .style("stroke", "#c7c7c7")
                                .style("stroke-width", 0.5)
                                .attr("x1", xShift + nt10/17 + Math.trunc(seqArrayItem.length / 10) * (nt10 + sp))
                                .attr("y1", yPos + middleWidth) 
                                .attr("x2", xShift + nt10 * (ntLeft / 10 ) - nt10/20 + Math.trunc(seqArrayItem.length / 10)  * (nt10 + sp)) 
                                .attr("y2", yPos + middleWidth);
                                //draw small vertical lines
                for(v=0; v < ntLeft; v++){
                    var vline = fcSeq.append("g").append("line")
                                    .style("stroke-width", 0.5)
                                    .style("stroke", "#c7c7c7")
                                    .attr("x1", xShift + Math.trunc(seqArrayItem.length / 10) * (nt10 + sp) + nt10/17 + v * nt10/10)
                                    .attr("y1", function () { return (v == 0 || v == 9 || v == 5) ? (yPos + 3) : (yPos + 4); }) 
                                    .attr("x2", xShift + Math.trunc(seqArrayItem.length / 10) * (nt10 + sp)+ nt10/17 + v * nt10/10)
                                    .attr("y2", function () { return (v == 0 || v == 9 || v == 5) ? (yPos + 9) : (yPos + 8); });
                }
        }
    }
    
    //complementary sequence
    if(showComplementary){
                    fcSeq.append("text")
                        .attr("class", "noEvent")
                        .attr("y", yPos + seqWidth)
                        .attr("x", xShift)
                        .style("text-anchor", "begin")
                        .style("font-family", "monospace")
                        .style("font-size", "13px")
                        .style("fill", "#c7c7c7")
                        .text(cSeqArray[i]);
    }                 
    //cal the y pos based on features
    //get current seq range
    var seqStart = ntPerLine * i + 1;
    var seqEnd = seqStart + ntPerLine;

    //first get the features that cover the whole range, complete overlapping features
    var coFeatures = $.grep(features, function (f, i) { 
        return f.start <= seqStart && f.end >= seqEnd;
     })
     //draw coFeatures
     var fWidth = 8;

     //calculate the feature rect width
     $('body').append('<div id="measure-text-width" class="nt-text-width">A G</div>');
     var rectWidth = $("#measure-text-width").text(seqArray[0]).width();
     $("#measure-text-width").remove();

     var coStep = 10; //vertical space between each feature
     var fNewWdith =0;
     if(coFeatures.length >=1){
     var feature = svgSeq.append("g");
        for(f = 0; f < coFeatures.length; f++){
            //feature line
             var featureRect = feature.append("line")
                                .data([coFeatures[f]]) //pass the data for mouse on events
                                .attr("class", function(){ return formatName(coFeatures[f].name, "line"); })
                                .style("stroke", coFeatures[f].color)
                                .style("stroke-opacity", 0.6)
                                .attr("x1", xShift)
                                .attr("y1", yPos + (seqWidth - 3 + coStep) * (f+1))
                                .attr("x2", xShift + rectWidth)
                                .attr("y2", yPos + (seqWidth - 3 + coStep) * (f+1));
                                //add mous eevents
                                featureRect.on("mouseover", function(d){
                                    //get the class
                                    var lineClass = '.'+ formatName(d.name, "line");
                                    var rectClass = '.'+formatName(d.name, "rect");
                                    var seqClass = '.' + formatName(d.name, "seq");
                                    d3.selectAll(lineClass).style("stroke-opacity", 1)
                                    d3.selectAll(rectClass).style("opacity", 0.5);
                                    d3.selectAll(seqClass).style("opacity", 0.1);
                                })
                                .on("mouseout", function(d){
                                    //get the class
                                    var lineClass = '.'+ formatName(d.name, "line");
                                    var rectClass = '.'+formatName(d.name, "rect");
                                    var seqClass = '.' + formatName(d.name, "seq");
                                    d3.selectAll(lineClass).style("stroke-opacity", 0.6)
                                    d3.selectAll(rectClass).style("opacity", 0.1);
                                    d3.selectAll(seqClass).style("opacity", 0.0);
                                });
            //hidden rect the span the seq
            var seqRect = svgSeq.append("rect")
                                .data([coFeatures[f]]) //pass the data for mouse on events
                                .attr("class", function(){ return formatName(coFeatures[f].name, "seq"); })
                                .style("fill", coFeatures[f].color)
                                .style("opacity", 0.0)
                                .attr("x", xShift)
                                .attr("y", yPos - seqWidth)
                                .attr("width", rectWidth)
                                .attr("height", 2*seqWidth+middleWidth);
            
            //label rect
            var featureBg = feature.append("rect")
                                .data([coFeatures[f]]) //pass the data for mouse on events
                                .attr("class", function(){ return formatName(coFeatures[f].name, "rect"); })
                                .style("fill", coFeatures[f].color)
                                .style("opacity", 0.1)
                                .attr("x", xShift + rectWidth / 2 - (coFeatures[f].name.split('').length + 10 ) * 7/2 )
                                .attr("y", yPos + (seqWidth - 3 + coStep) * (f + 1))
                                .attr("width", (coFeatures[f].name.split('').length + 10  ) * 7)
                                .attr("height", 1.2*yShift);
                                //add mous eevents
                                featureBg.on("mouseover", function(d){
                                    //get the class
                                    var lineClass = '.'+ formatName(d.name, "line");
                                    var rectClass = '.'+formatName(d.name, "rect");
                                    var seqClass = '.'  +formatName(d.name, "seq");
                                    d3.selectAll(lineClass).style("stroke-opacity", 1)
                                    d3.selectAll(rectClass).style("opacity", 0.5);
                                    d3.selectAll(seqClass).style("opacity", 0.1);
                                })
                                .on("mouseout", function(d){
                                    //get the class
                                    var lineClass = '.'+ formatName(d.name, "line");
                                    var rectClass = '.'+formatName(d.name, "rect");
                                    var seqClass = '.' +formatName(d.name, "seq");
                                    d3.selectAll(lineClass).style("stroke-opacity", 0.6)
                                    d3.selectAll(rectClass).style("opacity", 0.1);
                                    d3.selectAll(seqClass).style("opacity", 0.0);
                                });
            //label
            var featureLabel = feature.append("text")
                                .attr("class", "noEvent")
                                .attr("y", yPos + (seqWidth - 3 + coStep) * (f+1) + yShift)
                                .attr("x", xShift + rectWidth / 2)
                                .style("text-anchor", "middle")
                                .style("font-family", "monospace")
                                .style("font-size", "10px")
                                .style("fill", function () { return coFeatures[f].color; })
                                .text(function(){return (coFeatures[f].clockwise===0? ">>>> " : "<<<< ") + coFeatures[f].name  + (coFeatures[f].clockwise===0? " >>>>" : " <<<<"); });
        //add up the width
        fNewWdith =  fNewWdith + (seqWidth - 3 + coStep);
        }
     }
     
     var prefNewWdith = fNewWdith;
     //get all the features located in the range or partially overlapped
     //1: features do not start in the range, but end in the range
     //2: features start in the range but not end in the range
     //3: features start and also end in the range
    var poFeatures = $.grep(features, function (f, i) { 
            return ((f.start < seqStart && f.end > seqStart && f.end < seqEnd)|| (f.start > seqStart && f.start < seqEnd && f.end > seqEnd) || (f.start > seqStart && f.end < seqEnd) );
    })
    //sort array by start
    poFeatures.sort(sortByProperty('start'));
    // //line# of features
    var line = 0;
    var fLine =[];
    var total = poFeatures.length;
    for(a=0; a< total; a++){
        fLine.push([]);
    }
    if(total > 0){
        if(poFeatures.length === 1 ){
            fLine[0].push(poFeatures[0]);
        }
        else{
            //>1
            var rFeature = poFeatures[poFeatures.length - 1];
            fLine[line].push(rFeature);
            poFeatures.pop();

            while(true){                
                if(poFeatures.length ===0){
                    break;
                }

                poFeatures.sort(sortByProperty('start'));
                var tempArray = [];

                if(poFeatures.length ===1){
                    if(line==0){
                        if(poFeatures[0].end <= rFeature.start){
                            fLine[0].push(poFeatures[0]);
                            poFeatures.pop();
                        }
                        else{
                            fLine[1].push(poFeatures[0]);
                            poFeatures.pop();
                        }
                    }
                    else{
                        if(poFeatures[0].end <= rFeature.start){
                            fLine[line].push(poFeatures[0]);
                        }
                        else{
                            fLine[line+1].push(poFeatures[0]);
                        }                        
                        poFeatures.pop();
                    }                    
                }

                if(poFeatures.length ===0){
                    break;
                }

                var z = poFeatures.length;
                while(z--){                    
                    var lFeature = poFeatures[z]; 
                    if(lFeature.end <= rFeature.start){
                        fLine[line].push(lFeature);
                        rFeature = lFeature;
                        poFeatures.pop();
                    }
                    else{
                        tempArray.push(lFeature);
                        rFeature = lFeature;
                        poFeatures.pop();
                    }                
                }   
                
                if(tempArray.length == 0){
                    break;
                }else{
                    line++;
                    poFeatures = tempArray;
                    poFeatures.sort(sortByProperty('start'));               
                    rFeature = poFeatures[poFeatures.length - 1];
                    fLine[line].push(rFeature);
                    poFeatures.pop();
                }
            }
        }
    }
     //loop through the fLine array
     for(l=0; l < fLine.length; l++){
         if(fLine[l].length >0){
             fNewWdith =  fNewWdith + (seqWidth - 3  + coStep);
             var feature = svgSeq.append("g");
             for(k=0; k < fLine[l].length; k++){
                 //feature line
            var featureRect = feature.append("line")
                                .data([fLine[l][k]]) //pass the data for mouse on events
                                .attr("class", function(){ return formatName(fLine[l][k].name, "line"); })
                                .style("stroke", fLine[l][k].color)
                                .style("stroke-opacity", 0.6)
                                .attr("x1", function(){
                                    var fStart = fLine[l][k].start <= seqStart? 0: fLine[l][k].start - seqStart;
                                    return xShift + calRectWidth(rectWidth, ntPerLine, fStart);
                                })
                                .attr("y1", yPos + prefNewWdith + (seqWidth - 3 + coStep) * (l + 1))
                                .attr("x2", function(){
                                    var fEnd = fLine[l][k].end >= seqEnd? ntPerLine : fLine[l][k].end - seqStart;
                                    return xShift +calRectWidth(rectWidth, ntPerLine, fEnd);
                                })
                                .attr("y2", yPos + prefNewWdith + (seqWidth - 3 + coStep) * (l + 1));
                                //add mous eevents
                                featureRect.on("mouseover", function(d){
                                    //get the class
                                    var lineClass = '.'+ formatName(d.name, "line");
                                    var rectClass = '.'+formatName(d.name, "rect");
                                    var seqClass = '.' + formatName(d.name, "seq");
                                    d3.selectAll(lineClass).style("stroke-opacity", 1)
                                    d3.selectAll(rectClass).style("opacity", 0.5);
                                    d3.selectAll(seqClass).style("opacity", 0.1);
                                })
                                .on("mouseout", function(d){
                                    //get the class
                                    var lineClass = '.'+ formatName(d.name, "line");
                                    var rectClass = '.'+formatName(d.name, "rect");
                                    var seqClass = '.' + formatName(d.name, "seq");
                                    d3.selectAll(lineClass).style("stroke-opacity", 0.6)
                                    d3.selectAll(rectClass).style("opacity", 0.1);
                                    d3.selectAll(seqClass).style("opacity", 0.0);
                                });
            //hidden rect the span the seq
            var seqRect = svgSeq.append("rect")
                                .data([fLine[l][k]]) //pass the data for mouse on events
                                .attr("class", function(){ return formatName(fLine[l][k].name, "seq"); })
                                .style("fill", fLine[l][k].color)
                                .style("opacity", 0.0)

                                .attr("x", function(){
                                    var fStart = fLine[l][k].start <= seqStart? 0: fLine[l][k].start - seqStart;
                                    return xShift + calRectWidth(rectWidth, ntPerLine, fStart);
                                })
                                .attr("y", yPos - seqWidth)
                                .attr("width", function(){
                                    var fStart = fLine[l][k].start <= seqStart? 0: fLine[l][k].start - seqStart;
                                    var fEnd = fLine[l][k].end >= seqEnd? ntPerLine : fLine[l][k].end - seqStart;
                                    return calRectWidth(rectWidth, ntPerLine, fEnd) - calRectWidth(rectWidth, ntPerLine, fStart);
                                })
                                .attr("height", 2*seqWidth+middleWidth);

            //label rect
            var featureBg = feature.append("rect")
                                .data([fLine[l][k]]) //pass the data for mouse on events
                                .attr("class", function(){ return formatName(fLine[l][k].name, "rect"); })
                                .style("fill", fLine[l][k].color)
                                .style("opacity", 0.1)
                                .attr("x", function(){
                                    var fStart = fLine[l][k].start <= seqStart? 0: fLine[l][k].start - seqStart;
                                    var fEnd = fLine[l][k].end >= seqEnd? ntPerLine : fLine[l][k].end - seqStart;
                                    return xShift+ (calRectWidth(rectWidth, ntPerLine, fEnd) - calRectWidth(rectWidth, ntPerLine, fStart))/2 + calRectWidth(rectWidth, ntPerLine, fStart) - (fLine[l][k].name.split('').length + 10 ) * 7/2;
                                })
                                .attr("y", yPos + prefNewWdith + (seqWidth - 3 + coStep) * (l+1))
                                .attr("width", (fLine[l][k].name.split('').length + 10  ) * 7)
                                .attr("height", 1.2*yShift);

                                //add mous eevents
                                featureBg.on("mouseover", function(d){
                                    //get the class
                                    var lineClass = '.'+ formatName(d.name, "line");
                                    var rectClass = '.'+formatName(d.name, "rect");
                                    var seqClass = '.' + formatName(d.name, "seq");
                                    d3.selectAll(lineClass).style("stroke-opacity", 1)
                                    d3.selectAll(rectClass).style("opacity", 0.5);
                                    d3.selectAll(seqClass).style("opacity", 0.1);
                                })
                                .on("mouseout", function(d){
                                    //get the class
                                    var lineClass = '.'+ formatName(d.name, "line");
                                    var rectClass = '.'+formatName(d.name, "rect");
                                    var seqClass = '.' + formatName(d.name, "seq");
                                    d3.selectAll(lineClass).style("stroke-opacity", 0.6)
                                    d3.selectAll(rectClass).style("opacity", 0.1);
                                    d3.selectAll(seqClass).style("opacity", 0.0);
                                });

            //feature label
            var featureLabel = feature.append("text")
                                .attr("class", "noEvent")
                                .attr("y", yPos + prefNewWdith + (seqWidth - 3 + coStep) * (l+1) + yShift)
                                .attr("x", function(){
                                    var fStart = fLine[l][k].start <= seqStart? 0: fLine[l][k].start - seqStart;
                                    var fEnd = fLine[l][k].end >= seqEnd? ntPerLine : fLine[l][k].end - seqStart;
                                    return xShift+ (calRectWidth(rectWidth, ntPerLine, fEnd) - calRectWidth(rectWidth, ntPerLine, fStart))/2 + calRectWidth(rectWidth, ntPerLine, fStart);
                                })
                                .style("text-anchor", "middle")
                                .style("font-family", "monospace")
                                .style("font-size", "10px")
                                .style("fill", function () { return fLine[l][k].color; })
                                .text(function(){return (fLine[l][k].clockwise===0? ">>>> " : "<<<< ") + fLine[l][k].name  + (fLine[l][k].clockwise===0? " >>>>" : " <<<<"); });


             }         
         }
     }

     featureHeight = fNewWdith === 0 ? featureWdith : fNewWdith;
    //cal the y pos based on enzymes

    yPos = yPos + seqTop + enzymeWidth  + seqWidth + featureHeight + seqBottom;
    //cal the count 
    count = count + ntPerLine;
    }

    //draw vertical line after ntcount
    svgSeq.append("line")
            .style("stroke", "#c7c7c7")
            .attr("x1", xShift -5)     // x position of the first end of the line
            .attr("y1", 5 - enzymeWidth- seqTop)             // y position of the first end of the line
            .attr("x2", xShift -5)     // x position of the second end of the line
            .attr("y2", yPos);    // y position of the second end of the line

    return svgSeq;
  }


function sortByProperty(property) {
    'use strict';
    return function (a, b) {
        var sortStatus = 0;
        if (a[property] < b[property]) {
            sortStatus = -1;
        } else if (a[property] > b[property]) {
            sortStatus = 1;
        }
        return sortStatus;
    };
}


//cal the rectWidth
function calRectWidth(totalWidth, ntPerLine, ntPos){
    return (ntPos + Math.round(ntPos / 10 ))/(ntPerLine + Math.round(ntPerLine / 10)) * totalWidth;
}

//format feature for class
function formatName(name, type){
    var nameArray = name.split('');
    var finalArray = [];
    $.each(nameArray, function(i, d){
        if(i==0){
            if((/[a-zA-Z]/.test(d))){
                finalArray.push(d);
            }
        }
        else{
            if((/[a-zA-Z0-9]/.test(d))){
                finalArray.push(d);
            }
        }
    })
    return finalArray.join('')+"-"+type;
}